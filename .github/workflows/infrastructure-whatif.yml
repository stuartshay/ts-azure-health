name: Infrastructure What-If

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to preview'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
  pull_request:
    branches:
      - master
      - develop
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure-*.yml'

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  MAX_RETRY_ATTEMPTS: 5
  RETRY_BASE_DELAY: 2
  LOCATION: eastus

jobs:
  whatif:
    name: Bicep What-If Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Azure credentials
        id: check_credentials
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        run: |
          if [ -z "$AZURE_CLIENT_ID" ]; then
            echo "has_credentials=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è  Azure credentials not configured - skipping what-if preview"
          else
            echo "has_credentials=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Azure login
        if: steps.check_credentials.outputs.has_credentials == 'true'
        id: azure_login
        continue-on-error: true
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check login status
        if: steps.check_credentials.outputs.has_credentials == 'true'
        id: login_status
        run: |
          if [ "${{ steps.azure_login.outcome }}" = "success" ]; then
            echo "login_successful=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Azure login successful"
          else
            echo "login_successful=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è  Azure login failed - credentials may be invalid or expired"
          fi

      - name: Setup retry utilities
        if: steps.check_credentials.outputs.has_credentials == 'true' && steps.login_status.outputs.login_successful == 'true'
        shell: bash
        run: |
          # Create retry function for Azure operations
          cat > /tmp/retry-utils.sh << 'RETRY_EOF'
          #!/bin/bash

          # Retry function with exponential backoff for Azure operations
          retry_azure_operation() {
            local max_attempts=$1
            shift
            local description=$1
            shift
            local command=("$@")

            local attempt=1
            local delay=$RETRY_BASE_DELAY
            local max_delay=32

            echo "üîÑ Starting: $description"

            while [ $attempt -le $max_attempts ]; do
              echo "  Attempt $attempt/$max_attempts..."

              local output
              local exit_code

              set +e
              output=$("${command[@]}" 2>&1)
              exit_code=$?
              set -e

              if [ $exit_code -eq 0 ]; then
                echo "$output"
                echo "‚úÖ Success: $description"
                return 0
              fi

              if echo "$output" | grep -qE \
                "(AuthorizationFailed|InvalidAuthenticationToken|Forbidden|InvalidResourceGroupName)"; then
                echo "‚ùå Permanent failure detected: $description"
                echo "$output" >&2
                return $exit_code
              fi

              if [ $attempt -eq $max_attempts ]; then
                echo "‚ùå Failed after $max_attempts attempts: $description"
                echo "$output" >&2
                return $exit_code
              fi

              local error_type="Unknown error"
              if echo "$output" | grep -qE "TooManyRequests|429"; then
                error_type="Rate limit (429)"
              elif echo "$output" | grep -qE "ServiceUnavailable|503"; then
                error_type="Service unavailable (503)"
              elif echo "$output" | grep -qE "GatewayTimeout|504"; then
                error_type="Gateway timeout (504)"
              elif echo "$output" | grep -qE "InternalServerError|500"; then
                error_type="Internal server error (500)"
              elif echo "$output" | grep -qE "Conflict|409"; then
                error_type="Conflict (409)"
              fi

              echo "‚ö†Ô∏è  $error_type - Retrying in ${delay}s..."
              echo "    Error preview: $(echo "$output" | head -n 1)"

              sleep $delay

              delay=$((delay * 2))
              if [ $delay -gt $max_delay ]; then
                delay=$max_delay
              fi

              attempt=$((attempt + 1))
            done
          }
          RETRY_EOF

          chmod +x /tmp/retry-utils.sh
          echo "‚úÖ Retry utilities configured (max attempts: $MAX_RETRY_ATTEMPTS, base delay: ${RETRY_BASE_DELAY}s)"

      - name: Run What-If for Dev environment
        if: steps.check_credentials.outputs.has_credentials == 'true' && steps.login_status.outputs.login_successful == 'true' && (github.event_name == 'pull_request' || github.event.inputs.environment == 'dev')
        id: whatif_dev
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          RESOURCE_GROUP="rg-azure-health-dev"

          # Check if resource group exists
          if ! az group exists --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Resource group $RESOURCE_GROUP does not exist."
            echo "Please create it manually with: az group create --name $RESOURCE_GROUP --location $LOCATION"
            echo "Skipping what-if for dev environment."
            exit 0
          fi

          echo "Running what-if for Dev environment..."
          whatif_output=$(az deployment group what-if \
            --name "whatif-$(date +%Y%m%d-%H%M%S)" \
            --resource-group "$RESOURCE_GROUP" \
            --template-file infrastructure/main.bicep \
            --parameters infrastructure/dev.bicepparam \
            --result-format FullResourcePayloads 2>&1 || true)

          # Save output to file for comment
          echo "$whatif_output" > /tmp/whatif-dev.txt

          {
            echo "## Dev Environment What-If"
            echo '```'
            echo "$whatif_output"
            echo '```'
            echo ""
          } >> /tmp/whatif-summary.md

      - name: Run What-If for Staging environment
        if: steps.check_credentials.outputs.has_credentials == 'true' && steps.login_status.outputs.login_successful == 'true' && (github.event_name == 'pull_request' || github.event.inputs.environment == 'staging')
        id: whatif_staging
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          RESOURCE_GROUP="rg-azure-health-staging"

          # Check if resource group exists
          if ! az group exists --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Resource group $RESOURCE_GROUP does not exist."
            echo "Please create it manually with: az group create --name $RESOURCE_GROUP --location $LOCATION"
            echo "Skipping what-if for staging environment."
            exit 0
          fi

          echo "Running what-if for Staging environment..."
          whatif_output=$(az deployment group what-if \
            --name "whatif-$(date +%Y%m%d-%H%M%S)" \
            --resource-group "$RESOURCE_GROUP" \
            --template-file infrastructure/main.bicep \
            --parameters infrastructure/staging.bicepparam \
            --result-format FullResourcePayloads 2>&1 || true)

          # Save output to file for comment
          echo "$whatif_output" > /tmp/whatif-staging.txt

          {
            echo "## Staging Environment What-If"
            echo '```'
            echo "$whatif_output"
            echo '```'
            echo ""
          } >> /tmp/whatif-summary.md

      - name: Run What-If for Prod environment
        if: steps.check_credentials.outputs.has_credentials == 'true' && steps.login_status.outputs.login_successful == 'true' && (github.event_name == 'pull_request' || github.event.inputs.environment == 'prod')
        id: whatif_prod
        continue-on-error: true
        shell: bash
        run: |
          source /tmp/retry-utils.sh

          RESOURCE_GROUP="rg-azure-health"

          # Check if resource group exists
          if ! az group exists --name "$RESOURCE_GROUP" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Resource group $RESOURCE_GROUP does not exist."
            echo "Please create it manually with: az group create --name $RESOURCE_GROUP --location $LOCATION"
            echo "Skipping what-if for prod environment."
            exit 0
          fi

          echo "Running what-if for Prod environment..."
          whatif_output=$(az deployment group what-if \
            --name "whatif-$(date +%Y%m%d-%H%M%S)" \
            --resource-group "$RESOURCE_GROUP" \
            --template-file infrastructure/main.bicep \
            --parameters infrastructure/prod.bicepparam \
            --result-format FullResourcePayloads 2>&1 || true)

          # Save output to file for comment
          echo "$whatif_output" > /tmp/whatif-prod.txt

          {
            echo "## Prod Environment What-If"
            echo '```'
            echo "$whatif_output"
            echo '```'
          } >> /tmp/whatif-summary.md

      - name: Comment PR with What-If results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Check if credentials were available and login was successful
            const hasCredentials = '${{ steps.check_credentials.outputs.has_credentials }}' === 'true';
            const loginSuccessful = '${{ steps.login_status.outputs.login_successful }}' === 'true';

            let summary = '';

            if (!hasCredentials) {
              summary = `‚ö†Ô∏è  **Azure credentials not configured**

              The infrastructure what-if preview requires Azure credentials to be set up as repository secrets.

              To enable what-if previews, follow the setup instructions in:
              - [docs/GITHUB_ACTIONS_SETUP.md](https://github.com/${{ github.repository }}/blob/develop/docs/GITHUB_ACTIONS_SETUP.md)

              Required secrets:
              - \`AZURE_CLIENT_ID\`
              - \`AZURE_TENANT_ID\`
              - \`AZURE_SUBSCRIPTION_ID\``;
            } else if (!loginSuccessful) {
              summary = `‚ö†Ô∏è  **Azure login failed**

              Azure credentials are configured but login failed. This could indicate:
              - Expired or invalid credentials
              - Incorrect secret values
              - Permission issues with the service principal

              Please verify your Azure credentials and update the repository secrets if needed.

              To update credentials, follow the setup instructions in:
              - [docs/GITHUB_ACTIONS_SETUP.md](https://github.com/${{ github.repository }}/blob/develop/docs/GITHUB_ACTIONS_SETUP.md)`;
            } else {
              // Read the what-if summary
              try {
                summary = fs.readFileSync('/tmp/whatif-summary.md', 'utf8');
              } catch (error) {
                summary = '‚ö†Ô∏è Could not generate what-if preview. Check workflow logs for details.';
              }
            }

            const body = `## üîç Infrastructure What-If Preview

            This PR modifies infrastructure files. ${hasCredentials && loginSuccessful ? "Here's a preview of what would change when deployed:" : ''}

            ${summary}

            ---
            <sub>üí° ${hasCredentials && loginSuccessful ? 'This preview shows potential changes to both **dev** and **prod** environments based on the current Bicep templates.' : 'Configure valid Azure credentials to enable infrastructure change previews.'}</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Infrastructure What-If Preview')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
