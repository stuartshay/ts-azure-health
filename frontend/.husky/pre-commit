#!/usr/bin/env sh
cd "$(dirname "$0")/../.." || exit 1

# Security checks (fast)
if command -v gitleaks >/dev/null 2>&1; then
  echo "ðŸ”’ Checking for secrets and private keys..."
  gitleaks protect --staged --redact --verbose || {
    echo "âŒ Gitleaks found secrets in staged files!"
    exit 1
  }
fi

# Check for merge conflict markers
echo "ðŸ” Checking for merge conflicts..."
git diff --cached --check || {
  echo "âŒ Found merge conflict markers or whitespace errors!"
  exit 1
}

# Check for large files (>1MB)
echo "ðŸ“¦ Checking for large files..."
large_files=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt 1048576 ]; then echo "{}"; fi')
if [ -n "$large_files" ]; then
  echo "âŒ Large files detected (>1MB):"
  echo "$large_files"
  exit 1
fi

# Frontend linting and formatting
echo "âœ¨ Running lint-staged..."
cd frontend || exit 1
npx lint-staged
